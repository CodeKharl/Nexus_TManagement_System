#!/usr/bin/env bash

SRC_DIR='src'

BUILD_DIR='build'
JAVAC_FLAGS=(-d "$BUILD_DIR")

BIN_DIR='bin'
JAR_PATH="$BIN_DIR/Nexus.jar"
MANIFEST_PATH='META-INF/MANIFEST.MF'

JAR_FLAGS=(cfm "$JAR_PATH" "$MANIFEST_PATH" -C "$BUILD_DIR" .)

mkdir "$BUILD_DIR" "$BIN_DIR" "${MANIFEST_PATH%/*}" 2>/dev/null

SOURCES=()
while read -r src; do
    SOURCES+=("$src")
done < <(find "$SRC_DIR" -name '*.java')

: "${SOURCES[@]:?'no java file found.'}"

if ! javac "${JAVAC_FLAGS[@]}" "${SOURCES[@]}"; then
    echo 'failed to build classes.' >&2
    exit 1
fi

if ! jar "${JAR_FLAGS[@]}"; then
    echo 'failed to create the jar.' >&2
    exit 1
fi

echo 'Build successfully!'
